
const _replaceSelection = (cm, startEnd, ID) => {
    if(/editor-preview-active/.test(cm.getWrapperElement().lastChild.className))
        return;
    let [start, end] = startEnd;
    const startPoint = cm.getCursor("start"),
        endPoint = cm.getCursor("end");
    end = end.replace(/#(.*?)#/, ID);

    cm.replaceSelection(start + cm.getSelection() + end);

    startPoint.ch += start.length;

    if(startPoint !== endPoint) {
        endPoint.ch += start.length;
    }

    cm.setSelection(startPoint, endPoint);
    cm.focus();
};

export default({ codemirror, options }) => {
    const cm = codemirror;
    let input = document.createElement('input');
    input.type = "file";
    input.addEventListener('change', (e) => {
        options.uploadFile(e.target.files[0], (id) => {
            _replaceSelection(cm, options.insertTexts.addImg, id);
            input = null;
        });
    });

    input.click();
};